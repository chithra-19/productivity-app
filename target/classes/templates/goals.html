<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üéØ My Goals ‚Äì ClimbUp</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e0eafc, #cfdef3);
      min-height: 100vh;
      padding: 30px;
    }

    h1 {
      font-weight: 600;
      color: #333;
    }

    .card {
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(6px);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      transition: 0.3s;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #5a67d8, #6b46c1);
    }

    .badge {
      font-size: 0.8rem;
      padding: 6px 10px;
      border-radius: 8px;
    }

    .form-control, .form-select {
      border-radius: 10px;
    }

    #goal-list .card-body small {
      color: #666;
    }

    .action-buttons button {
      min-width: 90px;
    }
    
    .back-arrow {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  font-size: 16px;
  color: black;
  text-decoration: none;
  margin: 20px;
  transition: 0.2s ease-in-out;
}

.back-arrow:hover {
  color: #0056b3;
  transform: translateX(-3px);
}
    
  </style>
</head>

<body>

	<a href="/dashboard" class="back-arrow">
  <i class="bi bi-arrow-left-circle"></i> Back to Dashboard
</a>
	
  <div class="container">
  
    <h1 class="mb-4 text-center">üéØ My Goals</h1>

    <!-- Add Goal Form -->
    <div class="card mb-4 p-3">
      <div class="card-body">
        <h5 class="card-title mb-3">‚ûï Add New Goal</h5>
        <form id="add-goal-form">
          <div class="mb-2">
            <input type="text" id="goal-title" class="form-control" placeholder="Enter goal title..." required maxlength="150">
          </div>
          <div class="mb-2">
            <textarea id="goal-description" class="form-control" placeholder="Write a short description..." maxlength="500"></textarea>
          </div>
          <div class="mb-2 row">
            <div class="col">
              <input type="date" id="goal-due-date" class="form-control">
            </div>
            <div class="col">
              <select id="goal-priority" class="form-select">
                <option value="LOW">Low Priority</option>
                <option value="MEDIUM" selected>Medium Priority</option>
                <option value="HIGH">High Priority</option>
              </select>
            </div>
          </div>
          <button class="btn btn-primary w-100" type="submit">Add Goal</button>
        </form>
      </div>
    </div>

    <!-- Filter -->
    <div class="d-flex align-items-center mb-3">
      <label for="filter-status" class="form-label me-2 mb-0">Filter:</label>
      <select id="filter-status" class="form-select w-auto">
        <option value="ALL" selected>All</option>
        <option value="ACTIVE">Active</option>
        <option value="COMPLETED">Completed</option>
        <option value="DROPPED">Dropped</option>
      </select>
    </div>

    <!-- Goals List -->
    <div id="goal-list" class="row g-4"></div>
  </div>

  <script>
    const token = localStorage.getItem('token');

    // Fetch and render all goals
    async function fetchGoals() {
      try {
        const status = document.getElementById('filter-status').value;
        const response = await axios.get(`/goals?status=${status}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        renderGoals(response.data);
      } catch (err) {
        console.error('Error fetching goals:', err);
      }
    }

    // Render goals
    function renderGoals(goals) {
      const list = document.getElementById('goal-list');
      list.innerHTML = '';

      if (!goals.length) {
        list.innerHTML = `<p class="text-center text-muted">No goals found.</p>`;
        return;
      }

      goals.forEach(goal => {
        const goalId = goal.id ;

        const badgeClass = goal.completed ? 'success' : goal.dropped ? 'danger' : 'primary';
        const badgeText = goal.completed ? 'Completed' : goal.dropped ? 'Dropped' : 'Active';

        const card = document.createElement('div');
        card.className = 'col-md-6';
        card.innerHTML = `
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0">${goal.title}</h5>
                <span class="badge bg-${badgeClass}">${badgeText}</span>
              </div>
              <p class="card-text">${goal.description || ''}</p>              <small class="text-muted">üìÖ Due: ${goal.dueDate || 'N/A'} | ‚ö° Priority: ${goal.priority || 'Medium'}</small>
              
              <div class="mt-3 d-flex flex-wrap gap-2 action-buttons">
                ${!goal.completed && !goal.dropped ? `
                  <button class="btn btn-success btn-sm" onclick="completeGoal(${goalId})">‚úÖ Complete</button>
                  <button class="btn btn-warning btn-sm" onclick="dropGoal(${goalId})">üõë Drop</button>
                ` : ''}
                <button class="btn btn-secondary btn-sm" onclick="editGoal(${goalId}, '${goal.title}', '${goal.description || ''}')">‚úèÔ∏è Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteGoal(${goalId})">üóëÔ∏è Delete</button>
              </div>
            </div>
          </div>
        `;
        list.appendChild(card);
      });
    }

    // Add new goal
    document.getElementById('add-goal-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const newGoal = {
        title: document.getElementById('goal-title').value,
        description: document.getElementById('goal-description').value,
        dueDate: document.getElementById('goal-due-date').value,
        priority: document.getElementById('goal-priority').value
      };

      try {
        await axios.post('/goals/save', newGoal, {
          headers: { Authorization: `Bearer ${token}` }
        });
        e.target.reset();
        fetchGoals();
      } catch (err) {
        console.error('Error adding goal:', err);
      }
    });
// complete goal
 async function completeGoal(id) {
  try {
    await axios.put(`/goals/${id}/complete`, {}, { headers: { Authorization: `Bearer ${token}` } });

    // Remove the card in goals page
    const card = document.querySelector(`button[onclick="completeGoal(${id})"]`).closest('.col-md-6');
    if (card) card.remove();

    // Fetch achievements and update the achievements page (if open)
    if (window.updateAchievements) window.updateAchievements();

  } catch (err) {
    console.error('Error completing goal:', err);
  }
}
 
  
    // Drop goal
    async function dropGoal(id) {
      try {
        await axios.put(`/goals/${id}/drop`, {}, { headers: { Authorization: `Bearer ${token}` } });
        fetchGoals();
      } catch (err) {
        console.error('Error dropping goal:', err);
      }
    }

    // Edit goal
    async function editGoal(id, currentTitle, currentDesc) {
      const newTitle = prompt('Enter new goal title:', currentTitle);
      if (!newTitle) return;
      const newDesc = prompt('Enter new goal description:', currentDesc || '');

      try {
        await axios.put(`/goals/${id}`, { title: newTitle, description: newDesc }, { headers: { Authorization: `Bearer ${token}` } });
        fetchGoals();
      } catch (err) {
        console.error('Error editing goal:', err);
      }
    }

    // Delete goal
    async function deleteGoal(id) {
      if (!confirm('Are you sure you want to delete this goal?')) return;
      try {
        await axios.delete(`/goals/${id}`, { headers: { Authorization: `Bearer ${token}` } });
        fetchGoals();
      } catch (err) {
        console.error('Error deleting goal:', err);
      }
    }

    // Filter listener
    document.getElementById('filter-status').addEventListener('change', fetchGoals);

    // Initial load
    fetchGoals();

    // Expose globally for inline buttons
    window.completeGoal = completeGoal;
    window.dropGoal = dropGoal;
    window.editGoal = editGoal;
    window.deleteGoal = deleteGoal;
  </script>
</body>
</html>
