<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸŽ¯ My Goals â€“ ClimbUp</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e0eafc, #cfdef3);
      min-height: 100vh;
      padding: 30px;
    }
    h1 { font-weight: 600; color: #333; }
    .card {
      border: none; border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(6px);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover { transform: translateY(-4px); box-shadow: 0 6px 25px rgba(0,0,0,0.12); }
    .btn-primary { background: linear-gradient(135deg,#667eea,#764ba2); border: none; transition: 0.3s; }
    .btn-primary:hover { background: linear-gradient(135deg,#5a67d8,#6b46c1); }
    .badge { font-size: .8rem; padding: 6px 10px; border-radius: 8px; }
    .form-control, .form-select { border-radius: 10px; }
    #goal-list .card-body small { color: #666; }
    .action-buttons button { min-width: 90px; }
    .back-arrow { display:inline-flex; align-items:center; gap:6px; font-weight:600; font-size:16px; color:black; text-decoration:none; margin:20px; transition:.2s;}
    .back-arrow:hover { color:#0056b3; transform:translateX(-3px); }
    #edit-goal-container { max-width: 720px; margin: 18px auto 0; }
  </style>
</head>

<body>

  <a href="/dashboard" class="back-arrow">
    <i class="bi bi-arrow-left-circle"></i> Back to Dashboard
  </a>

  <div class="container">
    <h1 class="mb-4 text-center">ðŸŽ¯ My Goals</h1>

    <!-- Add Goal Form -->
    <div class="card mb-4 p-3">
      <div class="card-body">
        <h5 class="card-title mb-3">âž• Add New Goal</h5>
        <form id="add-goal-form">
          <div class="mb-2">
            <input type="text" id="goal-title" class="form-control" placeholder="Enter goal title..." required maxlength="150">
          </div>
          <div class="mb-2">
            <textarea id="goal-description" class="form-control" placeholder="Write a short description..." maxlength="500"></textarea>
          </div>
          <div class="mb-2 row">
            <div class="col">
              <input type="date" id="goal-due-date" class="form-control">
            </div>
            <div class="col">
              <select id="goal-priority" class="form-select">
                <option value="LOW">Low Priority</option>
                <option value="MEDIUM" selected>Medium Priority</option>
                <option value="HIGH">High Priority</option>
              </select>
            </div>
          </div>
          <button class="btn btn-primary w-100" type="submit">Add Goal</button>
        </form>
      </div>
    </div>

    <!-- Filter -->
    <div class="d-flex align-items-center mb-3">
      <label for="filter-status" class="form-label me-2 mb-0">Filter:</label>
      <select id="filter-status" class="form-select w-auto">
        <option value="ALL" selected>All</option>
        <option value="ACTIVE">Active</option>
        <option value="COMPLETED">Completed</option>
        <option value="DROPPED">Dropped</option>
      </select>
    </div>

    <!-- Goals List -->
    <div id="goal-list" class="row g-4"></div>
  </div>

  <div id="edit-goal-container" class="card p-3 mt-4" style="display:none;">
    <h5>Edit Goal</h5>

    <form id="edit-goal-form">
      <input type="hidden" id="edit-goal-id">

      <div class="mb-2">
        <label class="form-label">Title</label>
        <input type="text" id="edit-goal-title" class="form-control" required maxlength="150">
      </div>

      <div class="mb-2">
        <label class="form-label">Description</label>
        <textarea id="edit-goal-description" class="form-control" maxlength="500"></textarea>
      </div>

      <div class="mb-2">
        <label class="form-label">Due Date</label>
        <input type="date" id="edit-goal-due-date" class="form-control">
      </div>

      <div class="mb-2">
        <label class="form-label">Priority</label>
        <select id="edit-goal-priority" class="form-select">
          <option value="LOW">Low</option>
          <option value="MEDIUM">Medium</option>
          <option value="HIGH">High</option>
        </select>
      </div>

      <button class="btn btn-primary w-100 mt-2" type="submit">Save Changes</button>
      <button class="btn btn-secondary w-100 mt-2" type="button" id="cancel-edit">Cancel</button>
    </form>
  </div>


<script>
  const token = localStorage.getItem('token');

  // Fetch and render all goals
  async function fetchGoals() {
    try {
      const status = document.getElementById('filter-status').value;
      const res = await axios.get(`/goals?status=${status}`, { headers: { Authorization: `Bearer ${token}` } });
      renderGoals(res.data || []);
    } catch (err) {
      console.error('Error fetching goals:', err);
      document.getElementById('goal-list').innerHTML = `<p class="text-center text-muted">Failed to load goals.</p>`;
    }
  }

  // Render goals (creates DOM elements + safe event handlers)
  function renderGoals(goals) {
    const list = document.getElementById('goal-list');
    list.innerHTML = '';

    if (!goals.length) {
      list.innerHTML = `<p class="text-center text-muted">No goals found.</p>`;
      return;
    }

    goals.forEach(goal => {
      const goalId = goal.id;
      const badgeClass = goal.completed ? 'success' : goal.dropped ? 'danger' : 'primary';
      const badgeText = goal.completed ? 'Completed' : goal.dropped ? 'Dropped' : 'Active';

      const col = document.createElement('div');
      col.className = 'col-md-6';

      const card = document.createElement('div');
      card.className = 'card';

      const body = document.createElement('div');
      body.className = 'card-body';

      const top = document.createElement('div');
      top.className = 'd-flex justify-content-between align-items-center mb-2';
      top.innerHTML = `<h5 class="card-title mb-0"></h5><span class="badge bg-${badgeClass}">${badgeText}</span>`;
      top.querySelector('.card-title').textContent = goal.title;

      const p = document.createElement('p');
      p.className = 'card-text';
      p.textContent = goal.description || '';

      const small = document.createElement('small');
      small.className = 'text-muted';
      small.textContent = `ðŸ“… Due: ${goal.dueDate || 'N/A'} | âš¡ Priority: ${goal.priority || 'Medium'}`;

      const actions = document.createElement('div');
      actions.className = 'mt-3 d-flex flex-wrap gap-2 action-buttons';

      // Complete / Drop buttons only if active
      if (!goal.completed && !goal.dropped) {
        const completeBtn = document.createElement('button');
        completeBtn.className = 'btn btn-success btn-sm';
        completeBtn.type = 'button';
        completeBtn.textContent = 'âœ… Complete';
        completeBtn.addEventListener('click', () => completeGoal(goalId));
        actions.appendChild(completeBtn);

        const dropBtn = document.createElement('button');
        dropBtn.className = 'btn btn-warning btn-sm';
        dropBtn.type = 'button';
        dropBtn.textContent = 'ðŸ›‘ Drop';
        dropBtn.addEventListener('click', () => dropGoal(goalId));
        actions.appendChild(dropBtn);
      }

      // Edit button â€” opens inline edit form
      const editBtn = document.createElement('button');
      editBtn.className = 'btn btn-secondary btn-sm';
      editBtn.type = 'button';
      editBtn.textContent = 'âœï¸ Edit';
      editBtn.addEventListener('click', () => showEditForm(goalId, goal.title || '', goal.description || '', goal.dueDate || '', goal.priority || 'MEDIUM'));
      actions.appendChild(editBtn);

      // Delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-danger btn-sm';
      deleteBtn.type = 'button';
      deleteBtn.textContent = 'ðŸ—‘ï¸ Delete';
      deleteBtn.addEventListener('click', () => deleteGoal(goalId));
      actions.appendChild(deleteBtn);

      body.appendChild(top);
      body.appendChild(p);
      body.appendChild(small);
      body.appendChild(actions);

      card.appendChild(body);
      col.appendChild(card);
      list.appendChild(col);
    });
  }

  // Add new goal
  document.getElementById('add-goal-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const newGoal = {
      title: document.getElementById('goal-title').value,
      description: document.getElementById('goal-description').value,
      dueDate: document.getElementById('goal-due-date').value,
      priority: document.getElementById('goal-priority').value
    };

    try {
      await axios.post('/goals/save', newGoal, { headers: { Authorization: `Bearer ${token}` } });
      e.target.reset();
      fetchGoals();
    } catch (err) {
      console.error('Error adding goal:', err);
    }
  });

  // Complete goal (AJAX)
  async function completeGoal(id) {
    try {
      await axios.put(`/goals/${id}/complete`, {}, { headers: { Authorization: `Bearer ${token}` } });
      // Remove card locally for instant feedback
      const btn = document.querySelector(`button[onclick]`) || null; // no inline onclicks anymore
      fetchGoals();
      if (window.updateAchievements) window.updateAchievements();
    } catch (err) {
      console.error('Error completing goal:', err);
    }
  }

  // Drop goal
  async function dropGoal(id) {
    try {
      await axios.put(`/goals/${id}/drop`, {}, { headers: { Authorization: `Bearer ${token}` } });
      fetchGoals();
    } catch (err) {
      console.error('Error dropping goal:', err);
    }
  }

  // Show inline edit form and populate fields
  function showEditForm(id, title, desc, dueDate, priority) {
    document.getElementById('edit-goal-id').value = id;
    document.getElementById('edit-goal-title').value = title;
    document.getElementById('edit-goal-description').value = desc;
    document.getElementById('edit-goal-due-date').value = dueDate || "";
    document.getElementById('edit-goal-priority').value = priority || "MEDIUM";

    document.getElementById('edit-goal-container').style.display = 'block';
    window.scrollTo({ top: document.getElementById('edit-goal-container').offsetTop - 20, behavior: 'smooth' });
  }

  // Submit edit form
  document.getElementById('edit-goal-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = document.getElementById('edit-goal-id').value;

    const updatedGoal = {
      title: document.getElementById('edit-goal-title').value,
      description: document.getElementById('edit-goal-description').value,
      dueDate: document.getElementById('edit-goal-due-date').value,
      priority: document.getElementById('edit-goal-priority').value
    };

    try {
      await axios.put(`/goals/${id}`, updatedGoal, {
        headers: { Authorization: `Bearer ${token}` }
      });

      document.getElementById('edit-goal-container').style.display = 'none';
      fetchGoals();
    } catch (err) {
      console.error('Error updating goal:', err);
    }
  });


  // Delete goal (keeps confirmation)
  async function deleteGoal(id) {
    try {
      await axios.delete(`/goals/${id}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      fetchGoals();
    } catch (err) {
      console.error('Error deleting goal:', err);
    }
  }


  // Filter listener
  document.getElementById('filter-status').addEventListener('change', fetchGoals);

  // Initial load
  fetchGoals();

  // Expose some functions globally if other pages depend on them
  window.fetchGoals = fetchGoals;
</script>
</body>
</html>
