<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>Focus Sessions</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        body {
            background: linear-gradient(120deg, #f0f4ff, #d9e4ff);
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
        }
        h1 { 
            font-weight: 600; 
            text-align: center; 
        }
        .stats-card {
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .timer-display {
            font-size: 4rem;
            font-weight: 700;
            text-align: center;
            margin: 2rem 0;
            color: #333;
        }
        #session-list .list-group-item {
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.3s;
        }
        #session-list .list-group-item:hover {
            background-color: #f7f9ff;
        }
        .mark-success-btn {
            transition: all 0.2s;
        }
        .mark-success-btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h1>Focus Sessions</h1>

    <!-- Stats -->
    <div class="row my-4 g-4 text-center">
        <div class="col-md-4">
            <div class="card text-white bg-primary stats-card p-3 h-100">
                <h5>Total Minutes</h5>
                <p th:text="${totalFocusMinutes != null ? totalFocusMinutes : 0}" class="fs-3">0</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success stats-card p-3 h-100">
                <h5>Successful Sessions</h5>
                <p th:text="${successfulSessionsCount != null ? successfulSessionsCount : 0}" class="fs-3">0</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info stats-card p-3 h-100">
                <h5>Total Sessions</h5>
                <p th:text="${sessions != null ? sessions.size() : 0}" class="fs-3">0</p>
            </div>
        </div>
    </div>

    <!-- Timer -->
    <div class="timer-display" id="main-timer">00:00</div>

    <!-- New Session -->
    <div class="card p-3 mb-4">
        <h5 class="mb-3">Start a Focus Session</h5>
        <form id="create-session-form" th:action="@{'/api/focus-sessions/create/' + ${user.id}}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="number" class="form-control" id="duration" name="durationMinutes" placeholder="Duration (min)" min="1" max="180" required>
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="type" name="sessionType">
                        <option value="POMODORO">Pomodoro</option>
                        <option value="CUSTOM">Custom</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex">
                    <button type="submit" class="btn btn-primary flex-fill">Start</button>
                </div>
            </div>
            <textarea class="form-control mt-3" id="notes" name="notes" placeholder="Notes (optional)"></textarea>
        </form>
    </div>

    <!-- Session List -->
    <div id="session-list" class="list-group">
        <li class="list-group-item" th:each="session : ${sessions}" th:data-id="${session.id}" th:data-remaining-minutes="${session.remainingMinutes}">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong th:text="${session.durationMinutes} + ' min'">0 min</strong> - 
                    <span th:text="${session.sessionType}">Pomodoro</span> - 
                    <span class="status" th:if="${session.successful}">✅ Successful</span>
                    <span class="status" th:unless="${session.successful}">❌ Pending</span>
                </div>
                <button class="btn btn-sm btn-success mark-success-btn" th:if="${!session.successful}">Mark Successful</button>
            </div>
            <small th:if="${session.notes != null}" th:text="${session.notes}"></small>
            <div class="timer mt-2"></div>
        </li>
    </div>
</div>

<script th:inline="javascript">
    const userId = [[${user.id}]];
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    attachMarkSuccessfulButtons(document.getElementById("session-list"));

    const form = document.getElementById("create-session-form");
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = {
            durationMinutes: form.durationMinutes.value,
            sessionType: form.sessionType.value,
            notes: form.notes.value
        };
        const newSession = await postRequest(form.getAttribute("action"), data);
        appendSession("#session-list", newSession);
        form.reset();
    });

    // Initialize timers
    document.querySelectorAll("#session-list li").forEach(li => {
        const remaining = parseInt(li.dataset.remainingMinutes || 0);
        startTimer(li, { remainingMinutes: remaining, successful: li.querySelector('.status').textContent.includes('Successful') });
    });
});

// POST helper
async function postRequest(url, data) {
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
    const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json", [csrfHeader]: csrfToken },
        body: JSON.stringify(data)
    });
    return await res.json();
}

function appendSession(listSelector, session) {
    const li = document.createElement("li");
    li.className = "list-group-item";
    li.dataset.id = session.id;
    li.dataset.remainingMinutes = session.remainingMinutes;
    li.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong>${session.durationMinutes} min</strong> - 
                <span>${session.sessionType}</span> - 
                <span class="status">${session.successful ? '✅ Successful' : '❌ Pending'}</span>
            </div>
            ${!session.successful ? '<button class="btn btn-sm btn-success mark-success-btn">Mark Successful</button>' : ''}
        </div>
        ${session.notes ? `<small>${session.notes}</small>` : ''}
        <div class="timer mt-2"></div>
    `;
    document.querySelector(listSelector).prepend(li);
    attachMarkSuccessfulButtons(li);
    startTimer(li, session);
}

function attachMarkSuccessfulButtons(scope) {
    const buttons = scope.querySelectorAll('.mark-success-btn');
    buttons.forEach(btn => {
        btn.onclick = async () => {
            const li = btn.closest("li");
            await postRequest(`/api/focus-sessions/${li.dataset.id}/mark-successful/${userId}`, {});
            li.querySelector('.status').textContent = '✅ Successful';
            btn.remove();
        };
    });
}

function startTimer(li, session) {
    if (session.successful) return;
    let remaining = session.remainingMinutes * 60;
    const timerDiv = li.querySelector(".timer");

    const interval = setInterval(async () => {
        if (remaining <= 0) {
            clearInterval(interval);
            timerDiv.textContent = '⏱️ Done!';
            li.querySelector('.status').textContent = '✅ Successful';
            li.querySelector('.mark-success-btn')?.remove();
            return;
        }
        const minutes = Math.floor(remaining / 60).toString().padStart(2,'0');
        const seconds = (remaining % 60).toString().padStart(2,'0');
        timerDiv.textContent = `⏱️ ${minutes}:${seconds}`;
        remaining--;
    }, 1000);
}
</script>
</body>
</html>
